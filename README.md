# راهنمای فارسی (README) — Tunnel Menu (Iran <-> Foreign)

این اسکریپت یک **منوی مدیریتی** برای راه‌اندازی تونل **6to4 (SIT)** + **GRE روی IPv6 (ip6gre)** بین دو سرور (ایران و خارج) است.  
اسکریپت با انتخاب منو، فایل `/etc/rc.local` را **کامل جایگزین** می‌کند تا بعد از ریبوت، تونل‌ها خودکار بالا بیایند.

---

## قابلیت‌ها

### ✅ منو 1 — Setup on Iran server
روی **سرور ایران** اجرا می‌شود و:
- IP سرور ایران را **خودکار** از سیستم می‌گیرد (نیازی به وارد کردن نیست)
- IP سرور خارج را از شما می‌پرسد
- پورت SSH ایران را می‌پرسد (دیفالت `22`)
- محتوای `/etc/rc.local` را پاک و **با دستورات موردنیاز جایگزین** می‌کند
- در آخر با نمایش خلاصه و تایید شما، **ریبوت** می‌کند (قابل کنسل با Ctrl+C)

### ✅ منو 2 — Setup on Foreign server
روی **سرور خارج** اجرا می‌شود و:
- IP سرور خارج را **خودکار** می‌گیرد
- IP سرور ایران را از شما می‌پرسد
- `/etc/rc.local` را جایگزین می‌کند
- در آخر با تایید شما **ریبوت** می‌کند

### ✅ منو 3 و 4 — Ping
- منو 3: `ping 10.10.187.2`
- منو 4: `ping 10.10.187.1`

### ✅ منو 5 — Status (ONLINE/OFFLINE)
خروجی فقط یکی از این دو حالت است:
- `ONLINE` اگر:
  - اینترفیس‌ها وجود داشته باشند
  - UP باشند
  - IPهای مورد انتظار روی اینترفیس‌ها ست شده باشد
  - و Ping دو طرف (10.10.187.1 و 10.10.187.2) برقرار باشد
- در غیر این صورت: `OFFLINE`

### ✅ اعتبارسنجی ورودی‌ها
- IPها به شکل IPv4 معتبر بررسی می‌شوند (مثل `1.2.3.4`)
- پورت SSH باید عددی بین `1 تا 65535` باشد
- اگر اشتباه وارد کنید دوباره سوال می‌پرسد

### ✅ ریبوت امن (Safety)
قبل از ریبوت:
- خلاصه تنظیمات نشان داده می‌شود
- تایید می‌گیرد
- شمارش معکوس 5 ثانیه‌ای دارد
- با `Ctrl+C` می‌توانید ریبوت را کنسل کنید

---

## پیش‌نیازها

روی سرور Ubuntu/Debian معمولاً موجود است:
- `bash`
- `iproute2` (برای دستور `ip`)
- `iptables`
- `ping` (معمولاً از بسته iputils)

نکته: اسکریپت باید با **root** اجرا شود:
- `sudo ./tunnel-menu.sh`

---

## نصب و اجرا (روش پیشنهادی و مطمئن روی لینوکس)

### 1) ساخت فایل روی لینوکس (بدون مشکل CRLF)
این روش باعث می‌شود فایل شما **حتماً LF** باشد و مشکل `^M` نخورید:

```bash
cat > tunnel-menu.sh <<'EOF'
# (کد کامل اسکریپت را اینجا Paste کنید)
EOF
```

سپس:

```bash
chmod +x tunnel-menu.sh
sudo ./tunnel-menu.sh
```

---

## اجرا با curl (اگر فایل را روی GitHub گذاشتید)

> اگر فایل شما احتمالاً CRLF دارد (از ویندوز آپلود شده)، این روش امن است:

```bash
bash <(curl -fsSL "https://raw.githubusercontent.com/USERNAME/REPO/main/tunnel-menu.sh" | tr -d '\r')
```

یا:

```bash
curl -fsSL "https://raw.githubusercontent.com/USERNAME/REPO/main/tunnel-menu.sh" | tr -d '\r' | sudo bash
```

---

## توضیح تنظیمات داخل تونل‌ها (خلاصه)

### روی ایران
- SIT: `6to4_iran`
- IPv6 روی SIT: `2002:a00:100::1/64`
- GRE over IPv6: `GRE6Tun_iran`
- IPv4 روی GRE: `10.10.187.1/30`
- فعال‌سازی ip_forward و NAT/Port forward طبق rc.local

### روی خارج
- SIT: `6to4_Forign`
- IPv6 روی SIT: `2002:a00:100::2/64`
- GRE over IPv6: `GRE6Tun_Forign`
- IPv4 روی GRE: `10.10.187.2/30`

---

## نکات مهم

### 1) این اسکریپت `/etc/rc.local` را کامل جایگزین می‌کند
قبل از نوشتن، از آن بکاپ می‌گیرد:
- `/etc/rc.local.bak.YYYY-MM-DD_HHMMSS`

### 2) بعضی Ubuntuهای جدید rc.local را پیش‌فرض اجرا نمی‌کنند
اسکریپت در صورت نیاز یک سرویس systemd می‌سازد:
- `/etc/systemd/system/rc-local.service`

### 3) تفاوت ONLINE/OFFLINE
ONLINE فقط با **تمام شرط‌ها**:
- اینترفیس‌ها موجود باشند
- UP باشند
- IPهای درست رویشان باشد
- Ping هر دو آدرس برقرار باشد

---

## رفع خطاهای رایج (Troubleshooting)

### ❌ خطای `$'\r': command not found` یا `^M`
یعنی فایل شما CRLF است. راه‌حل:

**راه‌حل سریع اجرا:**
```bash
bash <(curl -fsSL "URL" | tr -d '\r')
```

**تبدیل فایل روی سرور به LF:**
```bash
sed -i 's/\r$//' tunnel-menu.sh
```

### ❌ خطای مربوط به pipefail
اگر فایل CRLF باشد، این خطا هم ظاهر می‌شود. با LF کردن فایل حل می‌شود.
(در نسخه‌های جدید اسکریپت pipefail به شکل امن فعال می‌شود.)

---

## نکات امنیتی
- قبل از اجرا مطمئن شوید IPها درست هستند (اشتباه باعث قطع ارتباط می‌شود).
- اگر روی سرور از راه دور SSH هستید، بهتر است یک دسترسی اضطراری (مثل کنسول پنل VPS) داشته باشید.

---

## ارتباط/پشتیبانی
Developer: Telegram `@mrraminol`
